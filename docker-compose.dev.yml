version: "3.8"

services:
  # CouchDB Service for Development
  couchdb-dev:
    image: couchdb:3.3
    container_name: taskflow-couchdb-dev
    restart: unless-stopped
    ports:
      - "5984:5984"
    environment:
      COUCHDB_USER: admin
      COUCHDB_PASSWORD: admin
    volumes:
      - couchdb_dev_data:/opt/couchdb/data
      - couchdb_dev_config:/opt/couchdb/etc/local.d
    networks:
      - taskflow-dev-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5984/_up"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Next.js Development Server
  taskflow-dev:
    build:
      context: .
      dockerfile: Dockerfile.dev
      target: development
    container_name: taskflow-nextjs-dev
    restart: unless-stopped
    ports:
      - "9002:9002" # Using the port from package.json dev script
    environment:
      # CouchDB Configuration
      COUCHDB_URL: http://admin:admin@couchdb-dev:5984
      COUCHDB_USER: admin
      COUCHDB_PASS: admin
      COUCHDB_HOST: couchdb-dev:5984
      COUCHDB_TASKS_DB: tasks_dev
      COUCHDB_TEMPLATES_DB: templates_dev
      COUCHDB_META_DB: meta_dev
      # Next.js Development Configuration
      NODE_ENV: development
      HOSTNAME: 0.0.0.0
      PORT: 9002
    volumes:
      # Mount source code for hot reload
      - .:/app
      - /app/node_modules
      - /app/.next
    depends_on:
      couchdb-dev:
        condition: service_healthy
    networks:
      - taskflow-dev-network

volumes:
  couchdb_dev_data:
    driver: local
  couchdb_dev_config:
    driver: local

networks:
  taskflow-dev-network:
    driver: bridge
